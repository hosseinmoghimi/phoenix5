{% extends "accounting/layout.html" %}
{% load static %}
{% block content %}
{% include "core/includes/page-app/navbar.html" %}


<div class="row">
    <div class="col-md-3">

    </div>
    <div class="col-md-6">
        <h5 class="text-center">
            گزارش
        </h5>
    </div>
    <div class="col-md-3">

    </div>



</div>
<div id="report-app">
    
<form @submit.prevent="get_report()">

    <div class="row">

        <div class="col-md-12">
            <div class="form-group">
                <label for="">جستجو

                </label>


                <input type="text" class="form-control" v-model="search_for">

            </div>


        </div>


        <div class="col-md-4">
            <div class="form-group">
                <label for="">حساب مالی مربوطه</label>
                <select class="form-control" v-model="account_id" name="" id="">
                    {% for account in accounts %}
                    <option value="{{account.id}}">{{account.title}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>


 
        <div class="col-md-4">
            <div class="form-group">
                <label for="">تاریخ شروع</label>

                <div class="row">

                    <div class="col-8">

                        <date-picker v-model="start_date"></date-picker>

                    </div>
                </div>
            </div>


        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label for="">تاریخ پایان</label>

                <div class="row">

                    <div class="col-8">

                        <date-picker v-model="end_date"></date-picker>

                    </div>
                </div>
            </div>


        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label for="">مبلغ
                    :
                    <span v-text="to_price(amount)"></span>

                </label>


                <input required type="number" class="form-control" min="0" v-model="amount">

            </div>


        </div>


        <div class="col-md-4">
            <div class="form-group">
                <label for="">نحوه پرداخت</label>


                <select v-model="payment_method" class="form-control">
                    {% for payment_method in payment_methods %}
                    <option value="{{payment_method}}">{{payment_method}}</option>

                    {% endfor %}
                </select>

            </div>


        </div>


 


        <div class="col-md-12 pt-4">
            <div class="form-group">
                <img src="{% static 'leo/img/loading.gif' %}" width="32" v-if="waiting" alt="">

                <button class="btn px-3 btn-success" type="submit">
                    <i class="fa fa-plus"></i>
                    گزارش گیری</button>
            </div>

        </div>
        <div class="col-md-12 text-right">
            <div class="my-3 text-right" v-if="message.show">
                <span :class="'alert alert-'+message.color">
                    <span class="farsi" v-html="message.body"></span>
                </span>
            </div>
        </div>
        <div class="col-md-12">
            {% include "accounting/includes/transactions-app/template.html" %}
        </div>
    </div>
</form>

</div>
{% endblock content %}


{% block script %}
<script>

    account_id = 0
</script>
{% if account %}
<script>
    let account_id = parseInt("{{account.id}}")
</script>
{% endif %}

{% include "accounting/includes/transactions-app/script.html" %}

<script>
    let report_app = new Vue({
        el: "#report-app",
        data: {
            account_id: account_id,
            start_date: current_date,
            end_date: current_date,
            amount: 0,
            search_for: "",
            waiting:false,
            payment_method:"",
            message :{show:false}
        },
        components: {
            DatePicker: VuePersianDatetimePicker,
        },
        methods: {
            get_report: function () {

                let payload = {
                    csrfmiddlewaretoken: csrfmiddlewaretoken,
                    account_id: this.account_id,
                    start_date: this.start_date,
                    end_date: this.end_date,
                    amount: this.amount,
                    search_for: this.search_for,
                    payment_method: this.payment_method,
                }
                console.log(payload)
                report_app.waiting = true
                let url = "{% url 'accounting:report' %}"
                $.post(url, payload).done((data) => {
                    report_app.waiting = false
                    console.log(data)
                    if (data.result === 'SUCCEED') {
                        if (typeof costs_app != "undefined") {
                            costs_app.costs.push(data.cost)
                        }
                        if (typeof transactions_app != "undefined") {
                            console.log("dfsdfsdf")
                            transactions_app.transactions=data.transactions
                            transactions_app.search_for="asdsfgdhfffffffffff"
                            console.log(transactions_app.transactions)
                        }
                        report_app.message = { show: true, body: "با موفقیت گزارش گیری شد.", color: 'success' }
                    }
                    if (data.result === 'FAILED') {
                        report_app.message = { show: true, body: "خطا در گزارش گیری ", color: 'danger' }
                    }
                    setTimeout(() => {
                        report_app.message = { show: false}

                    }, 3000);
                })
            },
            to_price: function (vall) {
                return  to_price(vall, "{{CURRENCY}}")
            },
        }
    })
</script>
{% endblock script %}