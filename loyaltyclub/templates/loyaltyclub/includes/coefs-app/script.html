{% load static %}

<script src="{% static 'persian/moment.js' %}"></script>
<script src="{% static 'persian/moment-jalaali.js' %}"></script>
<script src="{% static 'persian/vue-persian-datetime-picker-browser.js' %}"></script>

<script>
    // let rest_ = parseInt("{{rest}}")
    let coef_component_template=`{% include 'loyaltyclub/includes/coefs-app/component.html' %}`
    let coef_component = Vue.component('coef-component', {
        data: function () {
            return {
                message: { show: false }
            }
        },
        methods: {

            save: function () {
                coef_component_me=this
                let payload = {
                    csrfmiddlewaretoken: csrfmiddlewaretoken,
                    number: this.coef.number,
                    percentage: this.coef.percentage,
                }

                let aa = this
                let url_change_coef = "{% url 'loyaltyclub:change_coef' %}"

                let posting = $.post(url_change_coef, payload)
                posting.done((data) => {
                    if (data.result === 'SUCCEED') {
                        coef_component_me.message.body = data.message
                        coef_component_me.message.show= true
                        coef_component_me.message.color= "success"
                        setTimeout(() => {
                            coef_component_me.message.show = false
                        }, 1800);
                    }
                })
            },


        },
        props: ['coef'],
        template: coef_component_template,
    })

    let coefs = JSON.parse(`{{coefs_s|escapejs}}`)


    let coefs_app = new Vue({
        el: "#coefs-app",
        data: {
            coefs: coefs,

            number: coefs.length + 1,
            percentage: 3,
            message: { show: false },
            waiting: false,
        },
        components: {
            DatePicker: VuePersianDatetimePicker,
            coef_component,

        },
        methods: {
            to_price: function (vall, curr) {
                return to_price(vall, curr)
            },
            change_coefs: function (number, percentage) {
                let payload = {
                    csrfmiddlewaretoken: csrfmiddlewaretoken,
                    number: number,
                    percentage: percentage,
                }
                let url = "{% url 'loyaltyclub:change_coef' %}"
                $.post(url, payload).done(data => {
                    leolog(data)
                    let sw = false
                    coefs_app.coefs.forEach(coef => {
                        if (coef.number == data.coef.number) {
                            sw = true
                            coef.percentage = data.coef.percentage
                        }
                    });
                    if (!sw) {
                        coefs_app.coefs.push(data.coef)
                    }
                    coefs_app.number = coefs_app.coefs.length + 1
                })
            },
        },
    })
</script>