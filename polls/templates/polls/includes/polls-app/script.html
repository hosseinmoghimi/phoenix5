{% load to_json %}
<script>
    let polls = JSON.parse(`{{polls_s|escapejs}}`)
    let polls_app = new Vue({
        el: "#polls-app",
        data: {
            polls: polls,
            title: '',
            waiting: false,
            message: { show: false }
        },
        methods: {
            filter: function () {
                polls_app.waiting = true

                this.polls = polls.filter(poll => poll.title.indexOf(polls_app.title) > -1)
                polls_app.waiting = false

            },
            to_price: function (vall) {
                let color = 'primary'
                if (vall < 0)
                    color = 'danger'
                if (vall > 0)
                    color = 'success'
                vall = to_price(vall, "")
                return `
                    <span class="text-${color}">${vall}</span>
                    `
            },
            add_poll: function () {
                if (polls_app.title.length < 5) {
                    polls_app.message = {
                        show: true,
                        color: "danger",
                        body: "عنوان را وارد کنید حداقل 5 حرف"
                    }
                    setTimeout(() => {
                        polls_app.message = { show: false }
                    }, 2000)
                    return
                }
                polls_app.waiting = true
                let url = "{% url 'polls:add_poll' %}"
                let payload = {
                    csrfmiddlewaretoken: csrfmiddlewaretoken,
                    title: this.title,
                }
                $.post(url, payload).done((data) => {
                    console.log(data)
                    polls_app.waiting = false
                    if (data.result === "SUCCEED") {
                        polls_app.message = {
                            show: true,
                            color: "success",
                            body: "با موفقیت افزوده شد."
                        }
                        setTimeout(() => {
                            polls_app.message = { show: false }
                        }, 2000)


                        if (typeof polls_app != "undefined") {
                            polls_app.title = ""
                            polls_app.polls = polls
                            polls_app.polls.push(data.poll)
                        }
                    }
                })
            },




        }
    })

</script>